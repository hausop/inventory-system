name: keep-supabase-alive

on:
  # 每 5 天固定一次（UTC 03:00 執行）
  schedule:
    - cron: "0 3 */5 * *"
  # 需要立刻測試可手動觸發
  workflow_dispatch: {}

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Read 1 row via Supabase REST
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          HEARTBEAT_TABLE: ${{ secrets.HEARTBEAT_TABLE }}
        run: |
          set -e
          # 讀取 1 筆資料（不回傳內容，單純觸發活動）
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            "$SUPABASE_URL/rest/v1/$HEARTBEAT_TABLE?select=id&limit=1")
          echo "HTTP status: $STATUS"
          # 若未成功（例如專案被手動暫停），讓 workflow 告警
          if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 300 ]; then
            echo "Ping failed. If the project is paused, restore it once in the dashboard."
            exit 1
          fi
